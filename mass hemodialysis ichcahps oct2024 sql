-- Google Slides Presentation: https://docs.google.com/presentation/d/1s2FSxKii-jibbgQM40bntDp18xyhmKCVO8cl4u7ZRUM/edit?usp=sharing
-- This project was completed for learning purposes.

CREATE TABLE postgres.cms.dialysis_facility_ma (
    cms_certification_number_ccn VARCHAR(255),
    network VARCHAR(255),
    facility_name VARCHAR(255),
    five_star_date VARCHAR(50),
    five_star INTEGER,
    five_star_data_availability_code VARCHAR(50),
    address_line_1 VARCHAR(255),
    address_line_2 VARCHAR(255),
    city_town VARCHAR(255),
    state VARCHAR(50),
    zip_code VARCHAR(20),
    county_parish VARCHAR(255),
    telephone_number VARCHAR(50),
    profit_or_non_profit VARCHAR(100),
    chain_owned BOOLEAN,
    chain_organization VARCHAR(255),
    late_shift BOOLEAN,
    number_of_dialysis_stations INTEGER,
    offers_in_center_hemodialysis BOOLEAN,
    offers_peritoneal_dialysis BOOLEAN,
    offers_home_hemodialysis_training BOOLEAN,
    certification_date VARCHAR(50),
    claims_date VARCHAR(50),
    eqrs_date VARCHAR(50),
    smr_date VARCHAR(50),
    patient_survival_category_text VARCHAR(255),
    patient_survival_data_availability_code VARCHAR(50),
    number_of_patients_included_in_survival_summary INTEGER,
    mortality_rate_facility NUMERIC,
    mortality_rate_upper_confidence_limit NUMERIC,
    mortality_rate_lower_confidence_limit NUMERIC,
    shr_date VARCHAR(50),
    patient_hospitalization_category_text VARCHAR(255),
    patient_hospitalization_data_availability_code VARCHAR(50),
    number_of_patients_included_in_hospitalization_summary INTEGER,
    hospitalization_rate_facility NUMERIC,
    hospitalization_rate_upper_confidence_limit NUMERIC,
    hospitalization_rate_lower_confidence_limit NUMERIC,
    srr_date VARCHAR(50),
    patient_hospital_readmission_category VARCHAR(255),
    patient_hospital_readmission_data_availability_code VARCHAR(50),
    number_of_hospitalizations_in_hospital_readmission_summary INTEGER,
    readmission_rate_facility NUMERIC,
    readmission_rate_upper_confidence_limit NUMERIC,
    readmission_rate_lower_confidence_limit NUMERIC,
    strr_date VARCHAR(50),
    patient_transfusion_category_text VARCHAR(255),
    patient_transfusion_data_availability_code VARCHAR(50),
    number_of_patients_included_in_the_transfusion_summary INTEGER,
    transfusion_rate_facility NUMERIC,
    transfusion_rate_upper_confidence_limit NUMERIC,
    transfusion_rate_lower_confidence_limit NUMERIC,
    swr_date VARCHAR(50),
    swr_category_text VARCHAR(255),
    patient_transplant_waitlist_data_availability_code VARCHAR(50),
    number_of_patients_in_this_facility_for_swr INTEGER,
    standardized_first_kidney_transplant_waitlist_ratio NUMERIC,
    swr_confidence_upper_limit NUMERIC,
    swr_confidence_lower_limit NUMERIC,
    pppw_category_text VARCHAR(255),
    patient_prevalent_transplant_waitlist_data_availability_code VARCHAR(50),
    number_of_patients_for_pppw INTEGER,
    percentage_of_prevalent_patients_waitlisted NUMERIC,
    pppw_upper_confidence_limit NUMERIC,
    pppw_lower_confidence_limit NUMERIC,
    sedr_date VARCHAR(50),
    sedr_category_text VARCHAR(255),
    emergency_dpt_encounter_data_availability_code VARCHAR(50),
    number_of_patients_included_in_sedr_summary INTEGER,
    standardized_ed_visits_ratio_facility NUMERIC,
    sedr_upper_confidence_limit NUMERIC,
    sedr_lower_confidence_limit NUMERIC,
    ed30_date VARCHAR(50),
    ed30_category_text VARCHAR(255),
    emergency_dpt_encounter_ratio_30_days_data_availability_code VARCHAR(50),
    number_of_hospitalizations_included_in_ed30_summary INTEGER,
    standardized_ed_visits_30_days_ratio_facility NUMERIC,
    ed30_upper_confidence_limit NUMERIC,
    ed30_lower_confidence_limit NUMERIC,
    years_modality_switch_based_upon VARCHAR(255),
    smosr_classification_category_facility VARCHAR(255),
    modality_switch_data_availability_code VARCHAR(50),
    smosr_number_of_eligible_patients_facility INTEGER,
    smosr_standardized_modality_switch_ratio_facility NUMERIC,
    smosr_upper_confidence_limit_facility NUMERIC,
    smosr_lower_confidence_limit_facility NUMERIC,
    sir_date VARCHAR(50),
    patient_infection_category_text VARCHAR(255),
    patient_infection_data_availability_code VARCHAR(50),
    standard_infection_ratio NUMERIC,
    sir_upper_confidence_limit NUMERIC,
    sir_lower_confidence_limit NUMERIC,
    fistula_category_text VARCHAR(255),
    fistula_data_availability_code VARCHAR(50),
    number_of_patients_included_in_fistula_summary INTEGER,
    fistula_rate_facility NUMERIC,
    fistula_rate_upper_confidence_limit NUMERIC,
    fistula_rate_lower_confidence_limit NUMERIC,
    hcp_vaccination_data_collection_dates VARCHAR(255),
    hcp_vaccination_data_availability_code VARCHAR(50),
    healthcare_worker_covid19_vaccination_percentage NUMERIC,
    adult_hd_ktv_data_availability_code VARCHAR(50),
    number_of_adult_hd_patients_ktv_data INTEGER,
    number_of_adult_hd_patient_months_ktv_data INTEGER,
    percentage_of_adult_hd_patients_ktv_ge_1_2 NUMERIC,
    adult_pd_ktv_data_availability_code VARCHAR(50),
    number_of_adult_pd_patients_ktv_data INTEGER,
    number_of_adult_pd_patient_months_ktv_data INTEGER,
    percentage_of_adult_pd_pts_ktv_ge_1_7 NUMERIC,
    pediatric_hd_ktv_data_availability_code VARCHAR(50),
    number_of_pediatric_hd_patients_ktv_data INTEGER,
    number_of_pediatric_hd_patient_months_ktv_data INTEGER,
    percentage_of_pediatric_hd_patients_ktv_ge_1_2 NUMERIC,
    pediatric_pd_ktv_data_availability_code VARCHAR(50),
    number_of_pediatric_pd_patients_ktv_data INTEGER,
    number_of_pediatric_pd_patient_months_ktv_data INTEGER,
    percentage_of_pediatric_pd_patients_ktv_ge_1_8 NUMERIC,
    percentage_of_medicare_patients_hgb_lt_10 NUMERIC,
    hgb_lt_10_data_availability_code VARCHAR(50),
    percentage_of_medicare_patients_hgb_gt_12 NUMERIC,
    hgb_gt_12_data_availability_code VARCHAR(50),
    number_of_dialysis_patients_hgb_data INTEGER,
    hypercalcemia_data_availability_code VARCHAR(50),
    number_of_patients_in_hypercalcemia_summary INTEGER,
    number_of_patient_months_in_hypercalcemia_summary INTEGER,
    percentage_of_adult_patients_with_hypercalcemia NUMERIC,
    serum_phosphorus_data_availability_code VARCHAR(50),
    number_of_patients_in_serum_phosphorus_summary INTEGER,
    number_of_patient_months_in_serum_phosphorus_summary INTEGER,
    percentage_of_adult_patients_with_serum_phosphorus_lt_3_5 NUMERIC,
    percentage_of_adult_patients_with_serum_phosphorus_3_5_4_5 NUMERIC,
    percentage_of_adult_patients_with_serum_phosphorus_4_6_5_5 NUMERIC,
    percentage_of_adult_patients_with_serum_phosphorus_5_6_7_0 NUMERIC,
    percentage_of_adult_patients_with_serum_phosphorus_gt_7_0 NUMERIC,
    long_term_catheter_data_availability_code VARCHAR(50),
    number_of_patients_in_long_term_catheter_summary INTEGER,
    number_of_patient_months_in_long_term_catheter_summary INTEGER,
    percentage_of_adult_patients_with_long_term_catheter NUMERIC,
    npcr_data_availability_code VARCHAR(50),
    number_of_patients_in_npcr_summary INTEGER,
    number_of_patient_months_in_npcr_summary INTEGER,
    percentage_of_pediatric_hd_patients_npcr NUMERIC
);

---

CREATE TABLE postgres.cms.ich_cahps_ma (
    cms_certification_number_ccn VARCHAR(255),
    network VARCHAR(255),
    facility_name VARCHAR(255),
    address_line_1 VARCHAR(255),
    address_line_2 VARCHAR(255),
    city_town VARCHAR(255),
    state VARCHAR(50),
    zip_code VARCHAR(20),
    county_parish VARCHAR(255),
    telephone_number VARCHAR(50),
    profit_or_non_profit VARCHAR(100),
    chain_owned BOOLEAN,
    chain_organization VARCHAR(255),
    ich_cahps_date VARCHAR(50),
    ich_cahps_data_availability_code VARCHAR(50),
    lower_box_percent_nephrologists_communication_caring NUMERIC,
    middle_box_percent_nephrologists_communication_caring NUMERIC,
    top_box_percent_nephrologists_communication_caring NUMERIC,
    linearized_score_nephrologists_communication_caring NUMERIC,
    star_rating_nephrologists_communication_caring NUMERIC,
    lower_box_percent_quality_of_dialysis_center_care NUMERIC,
    middle_box_percent_quality_of_dialysis_center_care NUMERIC,
    top_box_percent_quality_of_dialysis_center_care NUMERIC,
    linearized_score_quality_of_dialysis_center_care NUMERIC,
    star_rating_quality_of_dialysis_center_care NUMERIC,
    lower_box_percent_providing_information_to_patients NUMERIC,
    top_box_percent_providing_information_to_patients NUMERIC,
    linearized_score_providing_information_to_patients NUMERIC,
    star_rating_providing_information_to_patients NUMERIC,
    lower_box_percent_rating_of_the_nephrologist NUMERIC,
    middle_box_percent_rating_of_the_nephrologist NUMERIC,
    top_box_percent_rating_of_the_nephrologist NUMERIC,
    linearized_score_rating_of_the_nephrologist NUMERIC,
    star_rating_of_the_nephrologist NUMERIC,
    lower_box_percent_rating_of_the_dialysis_center_staff NUMERIC,
    middle_box_percent_rating_of_the_dialysis_center_staff NUMERIC,
    top_box_percent_rating_of_the_dialysis_center_staff NUMERIC,
    linearized_score_rating_of_the_dialysis_center_staff NUMERIC,
    star_rating_of_the_dialysis_center_staff NUMERIC,
    lower_box_percent_rating_of_the_dialysis_facility NUMERIC,
    middle_box_percent_rating_of_the_dialysis_facility NUMERIC,
    top_box_percent_rating_of_the_dialysis_facility NUMERIC,
    linearized_score_rating_of_the_dialysis_facility NUMERIC,
    star_rating_of_the_dialysis_facility NUMERIC,
    total_number_of_completed_interviews INTEGER,
    ich_cahps_survey_star_rating NUMERIC,
    survey_response_rate NUMERIC
);

---

SELECT *
FROM postgres.cms.dialysis_facility_ma

SELECT *
FROM postgres.cms.ich_cahps_ma

---Cleaning up the certification_date column...

ALTER TABLE postgres.cms.dialysis_facility_ma
ALTER COLUMN certification_date TYPE DATE
USING TO_DATE(certification_date, 'DDMONYYYY');

---

SELECT *
FROM postgres.cms.dialysis_facility_ma;

---

--- JOIN these two tables:

SELECT 
    ratings.cms_certification_number_ccn AS cms_ccn,
    ratings.lower_box_percent_nephrologists_communication_caring,
    ratings.middle_box_percent_nephrologists_communication_caring,
    ratings.top_box_percent_nephrologists_communication_caring,
    ratings.star_rating_nephrologists_communication_caring,
    ratings.lower_box_percent_quality_of_dialysis_center_care,
    ratings.middle_box_percent_quality_of_dialysis_center_care,
    ratings.top_box_percent_quality_of_dialysis_center_care,
    ratings.star_rating_quality_of_dialysis_center_care,
    ratings.lower_box_percent_providing_information_to_patients,
    ratings.top_box_percent_providing_information_to_patients,
    ratings.star_rating_providing_information_to_patients,
    ratings.lower_box_percent_rating_of_the_nephrologist,
    ratings.middle_box_percent_rating_of_the_nephrologist,
    ratings.top_box_percent_rating_of_the_nephrologist,
    ratings.star_rating_of_the_nephrologist,
    ratings.lower_box_percent_rating_of_the_dialysis_center_staff,
    ratings.middle_box_percent_rating_of_the_dialysis_center_staff,
    ratings.top_box_percent_rating_of_the_dialysis_center_staff,
    ratings.star_rating_of_the_dialysis_center_staff,
    ratings.lower_box_percent_rating_of_the_dialysis_facility,
    ratings.middle_box_percent_rating_of_the_dialysis_facility,
    ratings.top_box_percent_rating_of_the_dialysis_facility,
    ratings.star_rating_of_the_dialysis_facility,
    ratings.ich_cahps_survey_star_rating,
    ratings.survey_response_rate,
    safety.facility_name,
    safety.address_line_1,
    safety.city_town,
    safety.state,
    safety.zip_code,
    safety.county_parish,
    safety.chain_organization,
    safety.number_of_dialysis_stations,
    safety.offers_in_center_hemodialysis,
    safety.offers_peritoneal_dialysis,
    safety.offers_home_hemodialysis_training,
    safety.certification_date,
    safety.number_of_patients_included_in_survival_summary,
    safety.mortality_rate_facility,
    safety.mortality_rate_lower_confidence_limit,
    safety.mortality_rate_upper_confidence_limit,
    safety.hospitalization_rate_facility,
    safety.hospitalization_rate_lower_confidence_limit,
    safety.hospitalization_rate_upper_confidence_limit,
    safety.standard_infection_ratio,
    safety.sir_lower_confidence_limit,
    safety.sir_upper_confidence_limit
FROM 
    postgres.cms.ich_cahps_ma AS ratings
LEFT JOIN 
    postgres.cms.dialysis_facility_ma AS safety 
ON 
    ratings.cms_certification_number_ccn = safety.cms_certification_number_ccn
WHERE 
    ratings.survey_response_rate > 0;

